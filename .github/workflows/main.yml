name: Update Playlist Files

on:
  push:
    paths:
      - 'original-playlist.m3u'
    branches: [ main ]
  schedule:
    - cron: '*/15 * * * *'  # 每15分钟运行一次
  workflow_dispatch:

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Check if source file changed
      id: check_changes
      run: |
        if git diff --name-only HEAD~1 HEAD | grep -q "original-playlist.m3u"; then
          echo "changes_detected=true" >> $GITHUB_OUTPUT
          echo "检测到源文件变化，继续处理..."
        else
          echo "changes_detected=false" >> $GITHUB_OUTPUT
          echo "源文件无变化，跳过处理"
        fi
    
    - name: Process playlist files (preserve format)
      if: steps.check_changes.outputs.changes_detected == 'true'
      run: |
        # 创建处理脚本，严格保持原始格式
        cat > process_playlist.py << 'EOF'
        #!/usr/bin/env python3
        import re
        
        def process_playlists():
            # 读取源文件
            with open('original-playlist.m3u', 'r', encoding='utf-8') as f:
                lines = f.readlines()
            
            # 处理生成两个版本
            catchup_lines = process_catchup_version(lines)
            rtp_lines = process_rtp_version(catchup_lines)
            
            # 写入文件，保持原始换行符
            with open('playlist-catchup.m3u', 'w', encoding='utf-8', newline='') as f:
                f.writelines(catchup_lines)
            
            with open('playlist-rtp.m3u', 'w', encoding='utf-8', newline='') as f:
                f.writelines(rtp_lines)
            
            print("✓ 播放列表文件已成功生成，格式保持不变")
        
        def process_catchup_version(lines):
            """处理回看版本，严格保持格式"""
            processed_lines = []
            i = 0
            
            while i < len(lines):
                line = lines[i]
                
                # 处理EXTINF行
                if line.startswith('#EXTINF:'):
                    # 只修改catchup-source中的时间参数，保持其他所有内容不变
                    if 'catchup-source=' in line:
                        # 替换时间参数格式
                        new_line = re.sub(
                            r'(\?tvdr=)\{utc:YmdHMS\}GMT-\{utcend:YmdHMS\}GMT',
                            r'\1${(b)yyyyMMddHHmmss}GMT-${(e)yyyyMMddHHmmss}GMT&r2h-seek-offset=-28800',
                            line
                        )
                        # 如果没有时间参数，添加参数
                        if new_line == line and '?tvdr=' not in line:
                            new_line = re.sub(
                                r'(catchup-source="[^"]+)"',
                                r'\1?tvdr=${(b)yyyyMMddHHmmss}GMT-${(e)yyyyMMddHHmmss}GMT&r2h-seek-offset=-28800"',
                                line
                            )
                        processed_lines.append(new_line)
                    else:
                        processed_lines.append(line)
                    
                    # 下一行是URL行，直接保留（格式不变）
                    i += 1
                    if i < len(lines) and not lines[i].startswith('#'):
                        processed_lines.append(lines[i])
                else:
                    # 其他行直接保留
                    processed_lines.append(line)
                
                i += 1
            
            return processed_lines
        
        def process_rtp_version(lines):
            """处理RTP版本，严格保持格式"""
            processed_lines = []
            
            for line in lines:
                # 替换所有rtsp://为HTTP代理格式，但保持行结构不变
                if 'rtsp://' in line:
                    new_line = re.sub(
                        r'rtsp://([^"\s\r\n]+)',
                        r'http://192.168.100.1:5140/rtsp/\1',
                        line
                    )
                    processed_lines.append(new_line)
                else:
                    processed_lines.append(line)
            
            return processed_lines
        
        if __name__ == "__main__":
            process_playlists()
        EOF
        
        python process_playlist.py
    
    - name: Check for changes in generated files
      if: steps.check_changes.outputs.changes_detected == 'true'
      id: check_generated
      run: |
        if git diff --name-only | grep -q "playlist-catchup.m3u\|playlist-rtp.m3u"; then
          echo "generated_changed=true" >> $GITHUB_OUTPUT
          echo "生成的文件有变化，准备提交..."
        else
          echo "generated_changed=false" >> $GITHUB_OUTPUT
          echo "生成的文件无变化，无需提交"
        fi
    
    - name: Commit and push changes
      if: steps.check_changes.outputs.changes_detected == 'true' && steps.check_generated.outputs.generated_changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add playlist-catchup.m3u playlist-rtp.m3u
        git commit -m "Auto-update playlist files - $(date +'%Y-%m-%d %H:%M:%S')"
        git push