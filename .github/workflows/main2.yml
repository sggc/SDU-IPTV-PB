name: Process IPTV Playlist

on:
  push:
    paths:
      - 'multicast/multicast-weifang.m3u'
  schedule:
    - cron: '*/15 * * * *'  # 每15分钟运行一次
  workflow_dispatch:  # 允许手动触发

jobs:
  process-playlist:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Download and process playlist
      run: |
        # 创建处理脚本
        cat > process_playlist.py << 'EOF'
        import requests
        import re
        
        # 下载原始文件
        url = "https://raw.githubusercontent.com/plsy1/iptv/refs/heads/main/multicast/multicast-weifang.m3u"
        response = requests.get(url)
        content = response.text
        
        # 按行分割
        lines = content.split('\n')
        
        # 存储频道信息
        channels = []
        current_channel = {}
        
        # 解析M3U文件
        for line in lines:
            line = line.strip()
            if line.startswith('#EXTINF:'):
                if current_channel:
                    channels.append(current_channel)
                current_channel = {'extinf': line, 'url': ''}
            elif line and not line.startswith('#EXTM3U'):
                if current_channel and 'url' in current_channel and not current_channel['url']:
                    current_channel['url'] = line
                else:
                    if current_channel:
                        channels.append(current_channel)
                        current_channel = {}
        
        if current_channel:
            channels.append(current_channel)
        
        # 处理规则1: CGTN所有频道分类改为"其他频道"
        for channel in channels:
            if 'CGTN' in channel['extinf'].upper():
                channel['extinf'] = re.sub(r'group-title="[^"]*"', 'group-title="其他频道"', channel['extinf'])
        
        # 处理规则2: 复制一份山东卫视到CCTV1下面并改分类为"央视频道"
        shandong_tv = None
        cctv1_index = -1
        
        for i, channel in enumerate(channels):
            if '山东卫视' in channel['extinf']:
                shandong_tv = channel.copy()
            if 'CCTV-1' in channel['extinf'] or 'CCTV1' in channel['extinf']:
                cctv1_index = i
        
        if shandong_tv and cctv1_index != -1:
            # 修改复制品的分类
            new_shandong = shandong_tv.copy()
            new_shandong['extinf'] = re.sub(r'group-title="[^"]*"', 'group-title="央视频道"', new_shandong['extinf'])
            channels.insert(cctv1_index + 1, new_shandong)
        
        # 处理规则3: CCTV4欧洲和美洲移动到山东少儿之后
        cctv4_europe = None
        cctv4_america = None
        shandong_kids_index = -1
        
        cctv4_europe_index = -1
        cctv4_america_index = -1
        
        for i, channel in enumerate(channels):
            if 'CCTV-4欧洲' in channel['extinf'] or 'CCTV4欧洲' in channel['extinf']:
                cctv4_europe = channel
                cctv4_europe_index = i
            elif 'CCTV-4美洲' in channel['extinf'] or 'CCTV4美洲' in channel['extinf']:
                cctv4_america = channel
                cctv4_america_index = i
            elif '山东少儿' in channel['extinf']:
                shandong_kids_index = i
        
        # 移动CCTV4欧洲和美洲
        if shandong_kids_index != -1:
            insert_index = shandong_kids_index + 1
            
            # 移除原来的位置
            indices_to_remove = []
            if cctv4_europe_index != -1:
                indices_to_remove.append(cctv4_europe_index)
            if cctv4_america_index != -1:
                indices_to_remove.append(cctv4_america_index)
            
            # 从高到低排序，避免索引变化问题
            indices_to_remove.sort(reverse=True)
            for index in indices_to_remove:
                channels.pop(index)
            
            # 插入到新位置
            if cctv4_america:
                channels.insert(insert_index, cctv4_america)
            if cctv4_europe:
                channels.insert(insert_index, cctv4_europe)
        
        # 处理规则4: 山东经济广播移到末尾并改分类为"广播频道"
        shandong_econ_index = -1
        shandong_econ = None
        
        for i, channel in enumerate(channels):
            if '山东经济广播' in channel['extinf']:
                shandong_econ_index = i
                shandong_econ = channel
                break
        
        if shandong_econ_index != -1:
            channels.pop(shandong_econ_index)
            # 修改分类
            shandong_econ['extinf'] = re.sub(r'group-title="[^"]*"', 'group-title="广播频道"', shandong_econ['extinf'])
            channels.append(shandong_econ)
        
        # 修改回看源
        for channel in channels:
            # 修改catchup-source格式
            if 'catchup-source=' in channel['extinf']:
                # 匹配原有的catchup-source
                old_catchup = re.search(r'catchup-source="([^"]*)"', channel['extinf'])
                if old_catchup:
                    old_url = old_catchup.group(1)
                    # 提取关键部分
                    key_part = re.search(r'iptv/Tvod/iptv/(.*)', old_url)
                    if key_part:
                        new_catchup = f'catchup="default" catchup-source="http://192.168.100.1:5140/rtsp/112.245.125.39:1554/iptv/Tvod/iptv/{key_part.group(1)}?tvdr=${{(b)yyyyMMddHHmmss}}GMT-${{(e)yyyyMMddHHmmss}}GMT&r2h-seek-offset=-28800"'
                        channel['extinf'] = re.sub(r'catchup-source="[^"]*"', new_catchup, channel['extinf'])
            
            # 修改直播源URL
            if channel['url']:
                # 处理rtsp源
                if 'rtsp://112.245.125.39:1554/iptv/Tvod/iptv/' in channel['url']:
                    channel['url'] = channel['url'].replace('rtsp://112.245.125.39:1554/iptv/Tvod/iptv/', 'http://192.168.100.1:5140/rtsp/112.245.125.39:1554/iptv/Tvod/iptv/')
                
                # 处理rtp源
                elif 'http://192.168.0.1:5140/rtp/' in channel['url']:
                    channel['url'] = channel['url'].replace('http://192.168.0.1:5140/rtp/', 'http://192.168.100.1:5140/rtp/')
        
        # 生成新的M3U内容
        new_content = '#EXTM3U\n'
        for channel in channels:
            new_content += channel['extinf'] + '\n'
            new_content += channel['url'] + '\n'
        
        # 写入文件
        with open('multicast-rtp.m3u', 'w', encoding='utf-8') as f:
            f.write(new_content)
        
        print("Playlist processing completed!")
        EOF
        
        # 运行处理脚本
        python process_playlist.py
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add multicast-rtp.m3u
        git diff --staged --quiet || git commit -m "Auto-update multicast-rtp.m3u"
        git push